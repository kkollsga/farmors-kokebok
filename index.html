<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mine Oppskrifter - Hjemmelaget og Koselig</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .font-display {
            font-family: 'Playfair Display', serif;
        }
        .recipe-card {
            transition: all 0.3s ease;
        }
        .recipe-card:hover {
            transform: translateY(-4px);
        }
        .star {
            transition: all 0.2s ease;
        }
        .star:hover {
            transform: scale(1.2);
        }
        .gradient-overlay {
            background: linear-gradient(135deg, rgba(251,207,232,0.1) 0%, rgba(254,249,195,0.1) 100%);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-orange-50 via-amber-50 to-yellow-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white/90 backdrop-blur-sm shadow-sm sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex justify-between items-center">
                <h1 class="font-display text-3xl text-amber-800">Mine Oppskrifter</h1>
                <div class="flex items-center space-x-4">
                    <button onclick="showAddRecipe()" class="bg-amber-600 text-white px-4 py-2 rounded-lg hover:bg-amber-700 transition">
                        + Ny Oppskrift
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Search Bar -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">
        <div class="bg-white rounded-xl shadow-sm p-4">
            <input type="text" id="searchInput" placeholder="S√∏k etter oppskrifter..." 
                   class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
        </div>
    </div>

    <!-- Recommendations Section -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">
        <div id="recommendations" class="mb-8">
            <h2 class="font-display text-2xl text-amber-800 mb-4">Anbefalte for deg</h2>
            <div id="recommendedRecipes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Recommended recipes will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Main Recipe Grid -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8 pb-12">
        <h2 class="font-display text-2xl text-amber-800 mb-4">Alle Oppskrifter</h2>
        <div id="recipeGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Recipe cards will be inserted here -->
        </div>
    </div>

    <!-- Recipe Modal -->
    <div id="recipeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div id="modalContent">
                    <!-- Recipe content will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add Recipe Modal -->
    <div id="addRecipeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl max-w-2xl w-full p-6">
                <h2 class="font-display text-2xl text-amber-800 mb-4">Legg til ny oppskrift</h2>
                <form id="addRecipeForm">
                    <input type="text" id="newTitle" placeholder="Oppskriftens navn" class="w-full mb-3 px-4 py-2 border rounded-lg" required>
                    <input type="text" id="newServings" placeholder="Porsjoner (f.eks. 16 stk.)" class="w-full mb-3 px-4 py-2 border rounded-lg" required>
                    <textarea id="newIngredients" placeholder="Ingredienser (en per linje)" rows="6" class="w-full mb-3 px-4 py-2 border rounded-lg" required></textarea>
                    <textarea id="newInstructions" placeholder="Fremgangsm√•te (en per linje)" rows="6" class="w-full mb-3 px-4 py-2 border rounded-lg" required></textarea>
                    <input type="url" id="newImage" placeholder="Bilde URL (valgfritt)" class="w-full mb-4 px-4 py-2 border rounded-lg">
                    <div class="flex space-x-3">
                        <button type="submit" class="bg-amber-600 text-white px-6 py-2 rounded-lg hover:bg-amber-700">Lagre</button>
                        <button type="button" onclick="closeAddRecipe()" class="bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400">Avbryt</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Recipe database (shared/static data)
        let recipeDatabase = {
            "recipe_1": {
                id: "recipe_1",
                title: "Rundstykker",
                servings: "ca. 16 stk.",
                ingredients: [
                    "500 g hvetemel",
                    "1 pose t√∏rrgj√¶r (ca. 11 g)",
                    "50 g sm√∏r (romtemperert eller smeltet)",
                    "1 ¬Ω ts salt",
                    "2 dl melk (lunken)",
                    "1 ¬Ω dl vann (lunkent)",
                    "1 ss sukker"
                ],
                instructions: [
                    "Bland det t√∏rre: Ha hvetemel, t√∏rrgj√¶r, salt og sukker i en stor bolle.",
                    "Tilsett v√¶ske og sm√∏r: Bland melk og vann, og varm til ca. 37‚Äì40 ¬∞C (litt varmere enn fingervarmt for t√∏rrgj√¶r). Ha dette i melblandingen sammen med sm√∏ret.",
                    "Elt deigen: Elt i kj√∏kkenmaskin i 8‚Äì10 minutter, eller for h√•nd i 12‚Äì15 minutter, til deigen er smidig og slipper bollen.",
                    "Hev: Dekk til bollen og la deigen heve p√• et lunt sted i ca. 1 time, eller til den er dobbelt s√• stor.",
                    "Form rundstykker: Del deigen i ca. 16 emner og trill til boller. Legg dem p√• et stekebrett med bakepapir.",
                    "Etterhev: Dekk til og la rundstykkene etterheve i 30‚Äì40 minutter.",
                    "Stek: Forvarm ovnen til 220 ¬∞C (over- og undervarme). Stek midt i ovnen i 10‚Äì12 minutter, til de er gylne og gjennomstekte.",
                    "Avkj√∏l: Avkj√∏l p√• rist."
                ],
                image: "https://images.unsplash.com/photo-1509440159596-0249088772ff?w=800&h=600&fit=crop",
                createdAt: "2024-01-15"
            },
            "recipe_2": {
                id: "recipe_2",
                title: "Kanelboller",
                servings: "12 stk.",
                ingredients: [
                    "500 g hvetemel",
                    "1 pose t√∏rrgj√¶r",
                    "2 dl melk",
                    "100 g sm√∏r",
                    "1 egg",
                    "100 g sukker",
                    "1 ts kardemomme",
                    "Fyll: sm√∏r, sukker, kanel"
                ],
                instructions: [
                    "Varm melken til fingervarm og l√∏s opp gj√¶ren.",
                    "Bland inn egg, sukker og kardemomme.",
                    "Tilsett mel gradvis og elt til smidig deig.",
                    "La heve i 45 minutter.",
                    "Kjevle ut, sm√∏r p√• fyll og rull sammen.",
                    "Skj√¶r i skiver og la etterheve i 30 minutter.",
                    "Stek ved 225¬∞C i 8-10 minutter."
                ],
                image: "https://images.unsplash.com/photo-1609126901738-d2134918a689?w=800&h=600&fit=crop",
                createdAt: "2024-01-10"
            },
            "recipe_3": {
                id: "recipe_3",
                title: "Focaccia",
                servings: "1 langpanne",
                ingredients: [
                    "500 g hvetemel",
                    "1 pose t√∏rrgj√¶r",
                    "3 dl vann",
                    "1 dl olivenolje",
                    "2 ts salt",
                    "Topping: oliven, tomater, rosmarin"
                ],
                instructions: [
                    "Bland mel, gj√¶r og salt.",
                    "Tilsett vann og olje, elt til smidig deig.",
                    "La heve i 1 time.",
                    "Trykk deigen ut i smurt form.",
                    "Lag fordypninger med fingrene.",
                    "Drypp over olje og str√∏ p√• topping.",
                    "La heve 30 minutter til.",
                    "Stek ved 220¬∞C i 20-25 minutter."
                ],
                image: "https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=800&h=600&fit=crop",
                createdAt: "2024-02-01"
            }
        };

        // User data (personal interactions with recipes)
        let userData = {
            "recipe_1": {
                rating: 4.5,
                userRating: null,
                ratingCount: 12,
                madeCount: 45,
                lastViewed: null,
                favorite: false
            },
            "recipe_2": {
                rating: 5,
                userRating: null,
                ratingCount: 28,
                madeCount: 89,
                lastViewed: "2024-12-20",
                favorite: false
            },
            "recipe_3": {
                rating: 4.8,
                userRating: null,
                ratingCount: 15,
                madeCount: 32,
                lastViewed: "2024-11-15",
                favorite: false
            }
        };

        // Load data from localStorage
        function loadData() {
            const storedRecipes = localStorage.getItem('recipeDatabase');
            const storedUserData = localStorage.getItem('userData');
            
            if (storedRecipes) {
                recipeDatabase = JSON.parse(storedRecipes);
            }
            
            if (storedUserData) {
                userData = JSON.parse(storedUserData);
            }
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('recipeDatabase', JSON.stringify(recipeDatabase));
            localStorage.setItem('userData', JSON.stringify(userData));
        }

        // Get recipe with user data merged
        function getRecipeWithUserData(recipeId) {
            const recipe = recipeDatabase[recipeId];
            const userInfo = userData[recipeId] || {
                rating: 0,
                userRating: null,
                ratingCount: 0,
                madeCount: 0,
                lastViewed: null,
                favorite: false
            };
            
            return { ...recipe, ...userInfo };
        }

        // Initialize user data for new recipe
        function initializeUserData(recipeId) {
            if (!userData[recipeId]) {
                userData[recipeId] = {
                    rating: 0,
                    userRating: null,
                    ratingCount: 0,
                    madeCount: 0,
                    lastViewed: null,
                    favorite: false
                };
            }
        }

        // Initialize
        loadData();

        // Render recipes
        function renderRecipes(recipesToRender = null) {
            const grid = document.getElementById('recipeGrid');
            grid.innerHTML = '';
            
            const recipeIds = recipesToRender || Object.keys(recipeDatabase);
            
            recipeIds.forEach(recipeId => {
                const recipeData = getRecipeWithUserData(recipeId);
                const card = createRecipeCard(recipeData);
                grid.appendChild(card);
            });
        }

        // Create recipe card
        function createRecipeCard(recipe) {
            const card = document.createElement('div');
            card.className = 'recipe-card bg-white rounded-xl shadow-md overflow-hidden cursor-pointer hover:shadow-xl';
            card.onclick = () => showRecipe(recipe.id);
            
            const imageUrl = recipe.image || `https://images.unsplash.com/photo-1555939594-58d7cb561ad1?w=800&h=600&fit=crop`;
            
            card.innerHTML = `
                <div class="h-48 bg-gradient-to-br from-amber-100 to-orange-100 relative overflow-hidden">
                    ${recipe.image ? `<img src="${imageUrl}" alt="${recipe.title}" class="w-full h-full object-cover">` : 
                    `<div class="w-full h-full flex items-center justify-center">
                        <span class="text-6xl opacity-30">üçû</span>
                    </div>`}
                </div>
                <div class="p-5">
                    <h3 class="font-display text-xl text-gray-800 mb-2">${recipe.title}</h3>
                    <p class="text-gray-600 text-sm mb-3">${recipe.servings}</p>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-1">
                            ${renderStars(recipe.rating)}
                            <span class="text-xs text-gray-500 ml-1">(${recipe.ratingCount || 0})</span>
                        </div>
                        <div class="flex items-center text-sm text-gray-600">
                            <span class="mr-1">üë®‚Äçüç≥</span>
                            <span>${recipe.madeCount || 0}</span>
                        </div>
                    </div>
                </div>
            `;
            
            return card;
        }

        // Render star rating
        function renderStars(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    stars += '<span class="text-amber-400">‚òÖ</span>';
                } else if (i - 0.5 <= rating) {
                    stars += '<span class="text-amber-400">‚òÜ</span>';
                } else {
                    stars += '<span class="text-gray-300">‚òÖ</span>';
                }
            }
            return stars;
        }

        // Show recipe modal
        function showRecipe(recipeId) {
            const recipe = getRecipeWithUserData(recipeId);
            if (!recipe) return;
            
            // Update last viewed
            if (!userData[recipeId]) {
                initializeUserData(recipeId);
            }
            userData[recipeId].lastViewed = new Date().toISOString();
            saveData();
            
            const modal = document.getElementById('recipeModal');
            const content = document.getElementById('modalContent');
            
            const imageUrl = recipe.image || `https://images.unsplash.com/photo-1555939594-58d7cb561ad1?w=800&h=600&fit=crop`;
            
            content.innerHTML = `
                <div class="relative">
                    <button onclick="closeRecipe()" class="absolute top-4 right-4 bg-white/90 rounded-full p-2 hover:bg-white z-10">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                    <div class="h-64 bg-gradient-to-br from-amber-100 to-orange-100 relative">
                        ${recipe.image ? `<img src="${imageUrl}" alt="${recipe.title}" class="w-full h-full object-cover">` : 
                        `<div class="w-full h-full flex items-center justify-center">
                            <span class="text-8xl opacity-30">üçû</span>
                        </div>`}
                        <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>
                        <div class="absolute bottom-4 left-6 text-white">
                            <h2 class="font-display text-3xl mb-1">${recipe.title}</h2>
                            <p class="text-lg opacity-90">${recipe.servings}</p>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center space-x-4">
                                <div class="flex items-center">
                                    ${renderInteractiveStars(recipe)}
                                </div>
                                <span class="text-sm text-gray-600">${recipe.ratingCount || 0} vurderinger</span>
                            </div>
                            <button onclick="madeThis('${recipe.id}')" class="bg-amber-600 text-white px-4 py-2 rounded-lg hover:bg-amber-700 transition">
                                Jeg lagde dette! (${recipe.madeCount || 0})
                            </button>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="font-display text-xl text-amber-800 mb-3">Ingredienser</h3>
                                <ul class="space-y-2">
                                    ${recipe.ingredients.map(ing => `
                                        <li class="flex items-start">
                                            <span class="text-amber-600 mr-2">‚Ä¢</span>
                                            <span class="text-gray-700">${ing}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                            
                            <div>
                                <h3 class="font-display text-xl text-amber-800 mb-3">Fremgangsm√•te</h3>
                                <ol class="space-y-3">
                                    ${recipe.instructions.map((inst, i) => `
                                        <li class="flex items-start">
                                            <span class="font-semibold text-amber-600 mr-3 mt-0.5">${i + 1}.</span>
                                            <span class="text-gray-700">${inst}</span>
                                        </li>
                                    `).join('')}
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        // Render interactive stars for rating
        function renderInteractiveStars(recipe) {
            let stars = '';
            const userRating = recipe.userRating || 0;
            for (let i = 1; i <= 5; i++) {
                const filled = i <= userRating;
                stars += `<button onclick="rateRecipe('${recipe.id}', ${i})" class="star text-2xl ${filled ? 'text-amber-400' : 'text-gray-300'} hover:text-amber-500">‚òÖ</button>`;
            }
            return stars;
        }

        // Close recipe modal
        function closeRecipe() {
            document.getElementById('recipeModal').classList.add('hidden');
        }

        // Rate recipe
        function rateRecipe(recipeId, rating) {
            if (!userData[recipeId]) {
                initializeUserData(recipeId);
            }
            
            const userInfo = userData[recipeId];
            const previousUserRating = userInfo.userRating;
            
            // If user had already rated, update the average
            if (previousUserRating) {
                const totalRating = userInfo.rating * userInfo.ratingCount;
                const newTotal = totalRating - previousUserRating + rating;
                userInfo.rating = newTotal / userInfo.ratingCount;
            } else {
                // New rating
                const totalRating = userInfo.rating * userInfo.ratingCount;
                userInfo.ratingCount++;
                userInfo.rating = (totalRating + rating) / userInfo.ratingCount;
            }
            
            userInfo.userRating = rating;
            
            saveData();
            showRecipe(recipeId); // Refresh modal
            renderRecipes(); // Refresh grid
        }

        // Made this recipe
        function madeThis(recipeId) {
            if (!userData[recipeId]) {
                initializeUserData(recipeId);
            }
            
            userData[recipeId].madeCount++;
            saveData();
            showRecipe(recipeId); // Refresh modal
            renderRecipes(); // Refresh grid
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filtered = Object.keys(recipeDatabase).filter(recipeId => {
                const recipe = recipeDatabase[recipeId];
                return recipe.title.toLowerCase().includes(query) ||
                       recipe.ingredients.some(ing => ing.toLowerCase().includes(query));
            });
            renderRecipes(filtered);
        });

        // Get recommendations
        function getRecommendations() {
            const recommended = document.getElementById('recommendedRecipes');
            
            let recs = [];
            const recipeIds = Object.keys(recipeDatabase);
            
            // Sort by various criteria for recommendations
            const threeDaysAgo = new Date();
            threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
            
            // Recently viewed but not in the last 3 days
            const oldViewed = recipeIds.filter(id => {
                const lastViewed = userData[id]?.lastViewed;
                if (!lastViewed) return false;
                const viewedDate = new Date(lastViewed);
                return viewedDate < threeDaysAgo;
            }).slice(0, 2);
            
            // Never viewed
            const neverViewed = recipeIds.filter(id => !userData[id]?.lastViewed).slice(0, 2);
            
            // Highly rated
            const highRated = recipeIds
                .filter(id => userData[id]?.rating > 0)
                .sort((a, b) => (userData[b]?.rating || 0) - (userData[a]?.rating || 0))
                .slice(0, 2);
            
            // Combine recommendations (unique)
            const recIdSet = new Set();
            [...oldViewed, ...neverViewed, ...highRated].forEach(id => {
                if (!recIdSet.has(id) && recs.length < 3) {
                    recIdSet.add(id);
                    recs.push(id);
                }
            });
            
            // If we don't have 3 recommendations, add random ones
            while (recs.length < 3 && recs.length < recipeIds.length) {
                const randomId = recipeIds[Math.floor(Math.random() * recipeIds.length)];
                if (!recIdSet.has(randomId)) {
                    recIdSet.add(randomId);
                    recs.push(randomId);
                }
            }
            
            recommended.innerHTML = '';
            recs.forEach(recipeId => {
                const recipeData = getRecipeWithUserData(recipeId);
                const card = createRecipeCard(recipeData);
                recommended.appendChild(card);
            });
        }

        // Generate unique ID for new recipes
        function generateRecipeId() {
            return 'recipe_' + Date.now();
        }

        // Show add recipe modal
        function showAddRecipe() {
            document.getElementById('addRecipeModal').classList.remove('hidden');
        }

        // Close add recipe modal
        function closeAddRecipe() {
            document.getElementById('addRecipeModal').classList.add('hidden');
            document.getElementById('addRecipeForm').reset();
        }

        // Add new recipe
        document.getElementById('addRecipeForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const recipeId = generateRecipeId();
            
            // Add to recipe database
            recipeDatabase[recipeId] = {
                id: recipeId,
                title: document.getElementById('newTitle').value,
                servings: document.getElementById('newServings').value,
                ingredients: document.getElementById('newIngredients').value.split('\n').filter(i => i.trim()),
                instructions: document.getElementById('newInstructions').value.split('\n').filter(i => i.trim()),
                image: document.getElementById('newImage').value || null,
                createdAt: new Date().toISOString()
            };
            
            // Initialize user data for new recipe
            initializeUserData(recipeId);
            
            saveData();
            renderRecipes();
            getRecommendations();
            closeAddRecipe();
        });

        // Close modals on outside click
        document.getElementById('recipeModal').addEventListener('click', (e) => {
            if (e.target.id === 'recipeModal') closeRecipe();
        });
        document.getElementById('addRecipeModal').addEventListener('click', (e) => {
            if (e.target.id === 'addRecipeModal') closeAddRecipe();
        });

        // Export recipes (for sharing)
        function exportRecipes() {
            const dataStr = JSON.stringify(recipeDatabase, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = 'recipes.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // Import recipes (for sharing)
        function importRecipes(jsonData) {
            try {
                const importedRecipes = JSON.parse(jsonData);
                Object.keys(importedRecipes).forEach(recipeId => {
                    recipeDatabase[recipeId] = importedRecipes[recipeId];
                    if (!userData[recipeId]) {
                        initializeUserData(recipeId);
                    }
                });
                saveData();
                renderRecipes();
                getRecommendations();
            } catch (e) {
                console.error('Error importing recipes:', e);
            }
        }

        // Initial render
        renderRecipes();
        getRecommendations();
    </script>
</body>
</html>
